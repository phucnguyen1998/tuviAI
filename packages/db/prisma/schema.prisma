generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubmissionStatus {
  CREATED
  CHART_READY
}

enum ReadingStatus {
  QUEUED
  RUNNING
  DONE
  FAILED
}

enum CorrectionType {
  FACT
  LOGIC
  STYLE
  MISSING
  OTHER
}

model User {
  id          String       @id @default(uuid())
  createdAt   DateTime     @default(now())
  email       String?      @unique
  displayName String?
  isAdmin     Boolean      @default(false)
  submissions Submission[]
  corrections Correction[]
}

model Submission {
  id                String       @id @default(uuid())
  createdAt         DateTime     @default(now())
  userId            String?
  user              User?        @relation(fields: [userId], references: [id])
  birthInput        Json
  normalizedBirth   Json?
  status            SubmissionStatus
  chart             Chart?
  readings          Reading[]
}

model Chart {
  id           String     @id @default(uuid())
  createdAt    DateTime   @default(now())
  submissionId String     @unique
  submission   Submission @relation(fields: [submissionId], references: [id])
  engineVersion String
  chartJson    Json
  renderUrl    String?
  checksum     String?
}

model PromptVersion {
  id              String     @id @default(uuid())
  createdAt       DateTime   @default(now())
  name            String     @unique
  isActive        Boolean    @default(false)
  systemPrompt    String
  rubric          Json?
  temperature     Float?
  maxOutputTokens Int?
  notes           String?
  readings        Reading[]
}

model Reading {
  id             String        @id @default(uuid())
  createdAt      DateTime      @default(now())
  submissionId   String
  submission     Submission    @relation(fields: [submissionId], references: [id])
  promptVersionId String
  promptVersion  PromptVersion @relation(fields: [promptVersionId], references: [id])
  modelName      String
  ragSnapshot    Json?
  status         ReadingStatus
  inputTokens    Int?
  outputTokens   Int?
  costUsd        Float?
  latencyMs      Int?
  readingText    String?
  readingJson    Json?
  corrections    Correction[]
}

model Correction {
  id              String         @id @default(uuid())
  createdAt       DateTime       @default(now())
  readingId       String
  reading         Reading        @relation(fields: [readingId], references: [id])
  adminId         String
  admin           User           @relation(fields: [adminId], references: [id])
  type            CorrectionType
  severity        Int
  span            Json?
  originalExcerpt String?
  correctedText   String
  notes           String?
  isAppliedToKb   Boolean        @default(false)
}
